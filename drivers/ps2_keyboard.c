#include "stdint.h"
#include "stddef.h"
#include "stdbool.h"

#include "libc/string.h"

#include "arch/arch.h"

#if !defined(__X86__)
#error "ps/2 keyboard only supported for x86"
#endif

#include "arch/asm.h"
#include "arch/interrupts.h"

#include "kernel/kernel.h"
#include "kernel/debug.h"

#define SHIFT_OFFSET 90
#define ALT_OFFSET 180
#define KEYMAP swiss_keymap

enum SCAN_CODES {
    SC_ESCAPE = 0x01,
    SC_BACKSPACE = 0x0E,
    SC_ENTER = 0x1C,
    SC_LEFT_CTRL = 0x1D,
    SC_LEFT_SHIFT = 0x2A,
    SC_RIGHT_SHIFT = 0x36,
    SC_LEFT_ALT = 0x38,
    SC_SPACE = 0x39,
    SC_CAPS_LOCK = 0x3A,
    SC_F1 = 0x3B,
    SC_F2 = 0x3C,
    SC_F3 = 0x3D,
    SC_F4 = 0x3E,
    SC_F5 = 0x3F,
    SC_F6 = 0x40,
    SC_F7 = 0x41,
    SC_F8 = 0x42,
    SC_F9 = 0x43,
    SC_F10 = 0x44,
    SC_HOME = 0x47,
    SC_UP = 0x48,
    SC_PAGE_UP = 0x49,
    SC_LEFT = 0x4B,
    SC_RIGHT = 0x4D,
    SC_END = 0x4F,
    SC_PAGE_DOWN = 0x51,
    SC_INSERT = 0x52,
    SC_DELETE = 0x53,
    SC_F11 = 0x57,
    SC_F12 = 0x58,
};

volatile uint8_t scancode;
volatile uint8_t keystates[0x80];

uint8_t swiss_keymap[270] = {
    // Normal
    0,
    0,
    '1',
    '2',
    '3',
    '4',
    '5',
    '6',
    '7',
    '8',
    '9',
    '0',
    '\'',
    '^',
    '\b',
    '\t',
    'q',
    'w',
    'e',
    'r',
    't',
    'z',
    'u',
    'i',
    'o',
    'p',
    0xFC,
    0xA8,
    '\n',
    0,
    'a',
    's',
    'd',
    'f',
    'g',
    'h',
    'j',
    'k',
    'l',
    0xF6,
    0xE4,
    0xA7,
    0,
    '$',
    'y',
    'x',
    'c',
    'v',
    'b',
    'n',
    'm',
    ',',
    '.',
    '-',
    0,
    0,
    0,
    ' ',
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    '<',
    0,
    0,
    0,

    // Shift

    0,
    0,
    '+',
    '"',
    '*',
    0xE7,
    '%',
    '&',
    '/',
    '(',
    ')',
    '=',
    '?',
    '`',
    '\b',
    '\t',
    'Q',
    'W',
    'E',
    'R',
    'T',
    'Z',
    'U',
    'I',
    'O',
    'P',
    0xE8,
    '!',
    '\n',
    0,
    'A',
    'S',
    'D',
    'F',
    'G',
    'H',
    'J',
    'K',
    'L',
    0xE9,
    0xDF,
    0xB0,
    0,
    0xA3,
    'Y',
    'X',
    'C',
    'V',
    'B',
    'N',
    'M',
    ';',
    ':',
    '_',
    0,
    0,
    0,
    ' ',
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    '>',
    0,
    0,
    0,

    // Alt

    0,
    0,
    0xA6,
    '@',
    '#',
    0,
    0,
    0xAC,
    '|',
    0xA2,
    0,
    0,
    0xB4,
    '~',
    '\b',
    '\t',
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    '[',
    ']',
    '\n',
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    '{',
    0,
    0,
    '}',
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    ' ',
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    '\\',
    0,
    0,
    0,
};

void keyboard_handler(regs_t* regs)
{
    uint8_t status = inb(0x64);

    if (status & 1) {
        scancode = inb(0x60);

        // pressed / released
        if (scancode > 0x80) {
            keystates[scancode - 0x80] = 0;
        } else {
            keystates[scancode] = 1;
        }
    }

    // send PIC EOI signal
    outb(0x20, 0x20);
}

CONSTRUCTOR rcode_t init_keyboard()
{
    set_keyboard_int(keyboard_handler);
    return RCODE_SUCESS;
}
